#include <msp430.h> 
#include "fix_fft.h"
#include <math.h>
#include <screen.h>
// Circular Memory - Time DEcimation in place whem sampling
// LCD Memory using for scroll event and draw extra memory first, then draw it (Screen Optimization)
// Writing Pixel by pixel is not possible, so at first we draw line by line but it was slow. Then we use
// First creating a memory for full spectrum then, write to screen 107x24

/**
 * main.c
 */

const char dat[1024] = {0, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, -1, 55, 110, -14, 40, 93, -32, 21, 73, -53, -1, 52, -74, -22, 31, -94, -41, 13, -111, -56, -1, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, -1, 55, 110, -14, 40, 93, -32, 21, 73, -53, 0, 52, -74, -22, 31, -94, -41, 13, -111, -56, -1, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, 0, 55, 110, -14, 40, 93, -32, 21, 73, -53, 0, 52, -74, -22, 31, -94, -41, 13, -111, -56, -1, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, 0, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, -1, 55, 110, -14, 40, 93, -32, 21, 73, -53, 0, 52, -74, -22, 31, -94, -41, 13, -111, -56, -1, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, 0, 55, 110, -14, 40, 93, -32, 21, 73, -53, 0, 52, -74, -22, 31, -94, -41, 13, -111, -56, 0, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, 0, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, -1, 55, 110, -14, 40, 93, -32, 21, 73, -53, 0, 52, -74, -22, 31, -94, -41, 13, -111, -56, -1, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, 0, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, -1, 55, 110, -14, 40, 93, -32, 21, 73, -53, 0, 52, -74, -22, 31, -94, -41, 13, -111, -56, -1, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, 0, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, -1, 55, 110, -14, 40, 93, -32, 21, 73, -53, 0, 52, -74, -22, 31, -94, -41, 13, -111, -56, -1, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, 0, 55, 110, -14, 40, 93, -32, 21, 73, -53, -1, 52, -74, -22, 31, -94, -41, 13, -111, -56, 0, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, 0, 55, 110, -14, 40, 93, -32, 21, 73, -53, -1, 52, -74, -22, 31, -94, -41, 13, -111, -56, 0, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 128, 7, 65, 122, -1, 55, 110, -14, 40, 93, -32, 21, 73, -53, -1, 52, -74, -22, 31, -94, -41, 13, -111, -56, 0, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, 0, 55, 110, -14, 40, 93, -32, 21, 73, -53, 0, 52, -74, -22, 31, -94, -41, 13, -111, -56, 0, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, 0, 55, 110, -14, 40, 93, -32, 21, 73, -53, -1, 52, -74, -22, 31, -94, -41, 13, -111, -56, 0, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, 0, 55, 110, -14, 40, 93, -32, 21, 73, -53, -1, 52, -74, -22, 31, -94, -41, 13, -111, -56, 0, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, 0, 55, 110, -14, 40, 93, -32, 21, 73, -53, -1, 52, -74, -22, 31, -94, -41, 13, -111, -56, 0, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, 0, 55, 110, -14, 40, 93, -32, 21, 73, -53, -1, 52, -74, -22, 31, -94, -41, 13, -111, -56, 0, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21, 87, -26, 40, 105, -9, 55, 119, 3, 65, 126, 8, 68, 127, 7, 65, 122, 0, 55, 110, -14, 40, 93, -32, 21, 73, -53, 0, 52, -74, -22, 31, -94, -41, 13, -111, -56, 0, -123, -66, -8, -128, -69, -9, -127, -66, -4, -120, -56, 8, -106, -41, 25, -88, -22, 45, -67, -1, 66, -46, 21};
signed char im[1024];
signed char real[1024];



#define SEND BIT6
#define A0 BIT0
#define A1 BIT1
#define A2 BIT2
#define ACK BIT7




int main(void)
{
	WDTCTL = WDTPW | WDTHOLD;	// stop watchdog timer
	
	initClockTo16MHz();

    //adc_config();

    timerA_config();


	P1DIR |= BIT0;
	P1DIR |= ACK;

	P2DIR &= ~(A0 | A1 | A2);

	P1OUT &= ~BIT0;




    screenConfig();
	//i2c_init ();

    /*
	volatile unsigned char readValue = 0;
    while(1)
    {
    //__delay_cycles(5000000);                             // Delay between transmissions
    delay_ms(100);
     //i2c_msp();
     P1OUT ^= BIT0;
     P1OUT ^= ACK;
     while(!SEND);
     readValue = (P1IN & (A0|A1|A2));
     readValue = readValue>>2;
     P1OUT ^= ACK;

     if(readValue)
         __no_operation();

    }
    readValue++;

/*
 *
 */
    printOpenningScreen();

    menu();
            __no_operation();

            /*

    menu();


    unsigned int i = 0;
    for (i = 0; i < 256; i++)
    {
            int newIndex = findDecimationIndex(i,8);
            real[newIndex] = dat[i];
    }
    unsigned char max_mag = spectrum(real,im);
    spectrumScreen(real,max_mag);
*/

            spectrumMode();

	P1OUT |= BIT0;
	__no_operation();



	//test_adc();

	while(1){
	    __no_operation();
	}
}
